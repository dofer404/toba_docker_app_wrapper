#!/usr/bin/env bash

DIRBIN=`dirname $0`
DIRPROY=$DIRBIN/../
DIRAPP=$DIRPROY/app
DIRBD=$DIRPROY/bd
ARCH_NOMBRE_BASEDEDATOS="$DIRPROY/NOMBRE_BASEDEDATOS"
ARCH_NOMBRE_ESQUEMABD="$DIRPROY/NOMBRE_ESQUEMABD"
ARCH_NOMBRE_BASEDEDATOS_AUTO="$DIRPROY/NOMBRE_BASEDEDATOS_AUTO"
ARCH_NOMBRE_BASEDEDATOSTOBA="$DIRPROY/NOMBRE_BASEDEDATOSTOBA"
NOMBRE_BASEDEDATOSTOBA_DEFECTO="toba_3"

if [ -f $ARCH_NOMBRE_BASEDEDATOS ];
then
  NOMBRE_BASEDEDATOS=$(cat $ARCH_NOMBRE_BASEDEDATOS)
  if [ -f $ARCH_NOMBRE_BASEDEDATOS_AUTO ];
  then
    rm $ARCH_NOMBRE_BASEDEDATOS_AUTO
  fi
else
  if [ -f $ARCH_NOMBRE_BASEDEDATOS_AUTO ];
  then
    NOMBRE_BASEDEDATOS=$(cat $ARCH_NOMBRE_BASEDEDATOS_AUTO)

    echo ""
    echo "Creando $(realpath --relative-to="$DIRPROY" $ARCH_NOMBRE_BASEDEDATOS)..."
    echo $NOMBRE_BASEDEDATOS > $ARCH_NOMBRE_BASEDEDATOS
    rm $ARCH_NOMBRE_BASEDEDATOS_AUTO
    echo "...echo."
  else
    echo "No se puede nombrar la base de datos porque no existe el archivo '$(realpath --relative-to="$DIRPROY" $ARCH_NOMBRE_BASEDEDATOS)'"
    exit 1
  fi
fi

if [ -f $ARCH_NOMBRE_ESQUEMABD ];
then
  NOMBRE_ESQUEMABD=$(cat $ARCH_NOMBRE_ESQUEMABD)
else
  echo "No se puede nombrar la base de datos porque no existe el archivo '$(realpath --relative-to="$DIRPROY" $ARCH_NOMBRE_ESQUEMABD)'"
  exit 2
fi

if [ -f $ARCH_NOMBRE_BASEDEDATOSTOBA ];
then
  NOMBRE_BASEDEDATOSTOBA=$(cat $ARCH_NOMBRE_BASEDEDATOSTOBA)
else
  NOMBRE_BASEDEDATOSTOBA=$NOMBRE_BASEDEDATOSTOBA_DEFECTO

  echo ""
  echo "Advertencia: no existe el archivo '$(realpath --relative-to="$DIRPROY" $ARCH_NOMBRE_BASEDEDATOSTOBA)':"
  echo " Como nombre de la base de datos de toba se usa: $(realpath --relative-to="$DIRPROY" $NOMBRE_BASEDEDATOSTOBA_DEFECTO)"
  echo ""
fi

CREARBDFILE=$DIRBD/bd_app_crear.sql
CREARBDTOBAFILE_SQL=$DIRBD/bd_toba_crear.sql
RESTAURARBKBDSFILE=$DIRBD/bds_backup_restaurar.sh
CREARBKBDSFILE=$DIRBD/bds_backup_crear.sh

CREARBDFILE_OK=$(grep "<NOMBRE\ BASEDEDATOS>" $CREARBDFILE)
CREARBDTOBAFILE_SQL_OK=$(grep "<NOMBRE\ BASEDEDATOSTOBA>" $CREARBDTOBAFILE_SQL)
RESTAURARBKBDSFILE_OK=$(grep "<NOMBRE\ BASEDEDATOSTOBA>" $RESTAURARBKBDSFILE)
CREARBKBDSFILE_OK=$(grep "<NOMBRE\ BASEDEDATOSTOBA>" $CREARBKBDSFILE)

MSG_SIN_PLACEHOLDERS="no contiene los placeholders necesarios para insertar el nombre. Ya estableció el nombre del proyecto?"
if [ ! "$CREARBDFILE_OK" ];
then
  echo "Error: $(realpath --relative-to="$DIRPROY" $CREARBDFILE): $MSG_SIN_PLACEHOLDERS"
  exit 3
fi
if [ ! "$CREARBDTOBAFILE_SQL_OK" ];
then
  echo "Error: $(realpath --relative-to="$DIRPROY" $CREARBDTOBAFILE_SQL): $MSG_SIN_PLACEHOLDERS"
  exit 4
fi
if [ ! "$RESTAURARBKBDSFILE_OK" ];
then
  echo "Error: $(realpath --relative-to="$DIRPROY" $RESTAURARBKBDSFILE): $MSG_SIN_PLACEHOLDERS"
  exit 5
fi
if [ ! "$CREARBKBDSFILE_OK" ];
then
  echo "Error: $(realpath --relative-to="$DIRPROY" $CREARBKBDSFILE): $MSG_SIN_PLACEHOLDERS"
  exit 6
fi

ARCHIVO_TOBA_BASES_INI_GENERICO="$DIRBIN/aux/bases_generico.ini"
ARCHIVO_TOBA_BASES_INI_READY="$DIRBIN/aux/bases.ini"
ARCHIVO_TOBA_BASES_INI_BACKUP="$DIRBIN/aux/bases_BAK.ini"
ARCHIVO_TOBA_BASES_INI_APP="$DIRAPP/instalacion/bases.ini"

if [ ! -f $ARCHIVO_TOBA_BASES_INI_READY ];
then
  echo "Error: No se encontró el archivo $(realpath --relative-to="$DIRPROY" $ARCHIVO_TOBA_BASES_INI_READY). Estableció el nombre del proyecto?"
  exit 7
fi

cp $CREARBKBDSFILE $RESTAURARBKBDSFILE $CREARBDTOBAFILE_SQL $CREARBDFILE $DIRBIN/aux/

if [ -f $ARCHIVO_TOBA_BASES_INI_APP ];
then
  cp $ARCHIVO_TOBA_BASES_INI_APP $ARCHIVO_TOBA_BASES_INI_BACKUP
fi

sed -i "s/<NOMBRE\ BASEDEDATOS>/$NOMBRE_BASEDEDATOS/g" $CREARBDFILE
sed -i "s/<NOMBRE\ BASEDEDATOS>/$NOMBRE_BASEDEDATOS/g" $ARCHIVO_TOBA_BASES_INI_READY
sed -i "s/<NOMBRE\ ESQUEMABD>/$NOMBRE_ESQUEMABD/g" $ARCHIVO_TOBA_BASES_INI_READY
sed -i "s/<NOMBRE\ BASEDEDATOSTOBA>/$NOMBRE_BASEDEDATOSTOBA/g" $ARCHIVO_TOBA_BASES_INI_READY
sed -i "s/<NOMBRE\ BASEDEDATOSTOBA>/$NOMBRE_BASEDEDATOSTOBA/g" $RESTAURARBKBDSFILE
sed -i "s/<NOMBRE\ BASEDEDATOSTOBA>/$NOMBRE_BASEDEDATOSTOBA/g" $CREARBDTOBAFILE_SQL
sed -i "s/<NOMBRE\ BASEDEDATOSTOBA>/$NOMBRE_BASEDEDATOSTOBA/g" $CREARBKBDSFILE

cp $ARCHIVO_TOBA_BASES_INI_READY $ARCHIVO_TOBA_BASES_INI_APP

exit 0
