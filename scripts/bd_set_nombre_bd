#!/usr/bin/env bash

DIRBIN=`dirname $0`
DIRPROY=$DIRBIN/../
DIRAPP=$DIRPROY/app
DIRBD=$DIRPROY/bd
ARCH_NOMBRE_BASEDEDATOS="$DIRPROY/NOMBRE_BASEDEDATOS"
ARCH_NOMBRE_BASEDEDATOSTOBA="$DIRPROY/NOMBRE_BASEDEDATOSTOBA"
NOMBRE_BASEDEDATOSTOBA_DEFECTO="toba_3"

if [ -f $ARCH_NOMBRE_BASEDEDATOS ];
then
  NOMBRE_BASEDEDATOS=$(cat $ARCH_NOMBRE_BASEDEDATOS)

  if [ -f $ARCH_NOMBRE_BASEDEDATOSTOBA ];
  then
    NOMBRE_BASEDEDATOSTOBA=$(cat $ARCH_NOMBRE_BASEDEDATOSTOBA)
  else
    NOMBRE_BASEDEDATOSTOBA=$NOMBRE_BASEDEDATOSTOBA_DEFECTO

    echo "Advertencia: no existe el archivo '$ARCH_NOMBRE_BASEDEDATOSTOBA':"
    echo " - Como nombre de la base de datos de toba se usa: $NOMBRE_BASEDEDATOSTOBA_DEFECTO"
  fi

  CREARBDFILE=$DIRBD/bd_app_crear.sql
  CREARBDTOBAFILE_SQL=$DIRBD/bd_toba_crear.sql
  RESTAURARBKBDSFILE=$DIRBD/bds_backup_restaurar.sh
  CREARBKBDSFILE=$DIRBD/bds_backup_crear.sh

  CREARBDFILE_OK=$(grep "<NOMBRE\ BASEDEDATOS>" $CREARBDFILE)
  CREARBDTOBAFILE_SQL_OK=$(grep "<NOMBRE\ BASEDEDATOSTOBA>" $CREARBDTOBAFILE_SQL)
  RESTAURARBKBDSFILE_OK=$(grep "<NOMBRE\ BASEDEDATOSTOBA>" $RESTAURARBKBDSFILE)
  CREARBKBDSFILE_OK=$(grep "<NOMBRE\ BASEDEDATOSTOBA>" $CREARBKBDSFILE)

  MSG_SIN_PLACEHOLDERS="no contiene los placeholders necesarios para insertar el nombre. Ya estableci√≥ el nombre del proyecto?"
  if [ ! "$CREARBDFILE_OK" ];
  then
    echo "Error: $CREARBDFILE: $MSG_SIN_PLACEHOLDERS"
    exit 1
  fi
  if [ ! "$CREARBDTOBAFILE_SQL_OK" ];
  then
    echo "Error: $CREARBDTOBAFILE_SQL: $MSG_SIN_PLACEHOLDERS"
    exit 1
  fi
  if [ ! "$RESTAURARBKBDSFILE_OK" ];
  then
    echo "Error: $RESTAURARBKBDSFILE: $MSG_SIN_PLACEHOLDERS"
    exit 1
  fi
  if [ ! "$CREARBKBDSFILE_OK" ];
  then
    echo "Error: $CREARBKBDSFILE: $MSG_SIN_PLACEHOLDERS"
    exit 1
  fi

  cp $CREARBKBDSFILE $RESTAURARBKBDSFILE $CREARBDTOBAFILE_SQL $CREARBDFILE $DIRBIN/aux/

  sed -i "s/<NOMBRE\ BASEDEDATOS>/$NOMBRE_BASEDEDATOS/g" $CREARBDFILE
  sed -i "s/<NOMBRE\ BASEDEDATOSTOBA>/$NOMBRE_BASEDEDATOSTOBA/g" $RESTAURARBKBDSFILE
  sed -i "s/<NOMBRE\ BASEDEDATOSTOBA>/$NOMBRE_BASEDEDATOSTOBA/g" $CREARBDTOBAFILE_SQL
  sed -i "s/<NOMBRE\ BASEDEDATOSTOBA>/$NOMBRE_BASEDEDATOSTOBA/g" $CREARBKBDSFILE

  exit 0
fi

echo "No se puede nombrar la base de datos porque no existe el archivo '$ARCH_NOMBRE_BASEDEDATOS'"
exit 1
